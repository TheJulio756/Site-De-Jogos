<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Termos - ApproveIt Games</title>
    <link rel="stylesheet" href="commons.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #667eea;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: #667eea;
            color: white;
        }

        .nav-links a.active {
            background: #667eea;
            color: white;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .form-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .form-section h2 {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-danger {
            background: #ff6b6b;
        }

        .btn-danger:hover {
            background: #ff5252;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .terms-list {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .terms-list h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 1.5rem;
            font-size: 1.8rem;
        }

        .term-item {
            border-bottom: 1px solid #e1e5e9;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .term-item:hover {
            background: #f8f9fa;
        }

        .term-item:last-child {
            border-bottom: none;
        }

        .term-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .term-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin: 0;
            flex: 1;
        }

        .term-category {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .term-definition {
            color: #666;
            line-height: 1.6;
            margin-bottom: 1rem;
            word-wrap: break-word;
        }

        .term-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #667eea;
        }

        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success {
            background: #e6f7e6;
            color: #00b894;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .category-select-container {
            display: flex;
            gap: 0.5rem;
            align-items: stretch;
        }

        .category-select-container select {
            flex: 1;
        }

        .category-select-container button {
            white-space: nowrap;
            padding: 0.75rem 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }

            .term-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }

            .term-category {
                align-self: flex-start;
            }

            .term-actions {
                justify-content: flex-start;
            }

            .category-select-container {
                flex-direction: column;
            }

            .category-select-container button {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gerenciar Termos</h1>
            <p>Cadastre e organize seus termos e definições para criar jogos educativos</p>
        </div>

        <div class="nav-bar">
            <div class="nav-links">
                <a href="indexcomeco.html">Início</a>
                <a href="terms.html" class="active">Termos</a>
                <a href="games.html">Jogos</a>
            </div>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>

        <div id="message-container"></div>

        <div class="form-section">
            <h2 id="form-title">Adicionar Novo Termo</h2>
            <form id="term-form">
                <input type="hidden" id="term-id" value="">
                
                <div class="form-group">
                    <label for="term">Termo:</label>
                    <input type="text" id="term" name="term" required>
                </div>

                <div class="form-group">
                    <label for="definition">Definição:</label>
                    <textarea id="definition" name="definition" required></textarea>
                </div>

                <div class="form-group">
                    <label for="category">Categoria:</label>
                    <div class="category-select-container">
                        <select id="category" name="category">
                            <option value="">Selecione uma categoria</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="showAddCategoryModal()">
                            + Nova
                        </button>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button type="submit" class="btn" id="submit-btn">Adicionar Termo</button>
                    <button type="button" class="btn btn-secondary" id="cancel-btn" onclick="cancelEdit()" style="display: none;">Cancelar</button>
                </div>
            </form>
        </div>

        <div class="terms-list">
            <h2>Meus Termos</h2>
            <div id="terms-container">
                <div class="loading">Carregando termos...</div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Categoria -->
    <div id="category-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #333;">Adicionar Nova Categoria</h3>
            <form id="category-form">
                <div class="form-group">
                    <label for="new-category-name">Nome da Categoria:</label>
                    <input type="text" id="new-category-name" required placeholder="Ex: Biologia, Física, etc.">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="hideAddCategoryModal()">Cancelar</button>
                    <button type="submit" class="btn">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let editingTermId = null;

        // Dados de exemplo para demonstração (substitui as chamadas da API quando não autenticado)
        const sampleCategories = [
            { name: 'biologia', isDefault: true },
            { name: 'fisica', isDefault: true },
            { name: 'matematica', isDefault: true },
            { name: 'quimica', isDefault: true },
            { name: 'historia', isDefault: true },
            { name: 'geografia', isDefault: true }
        ];

        const sampleTerms = [
            {
                _id: '1',
                term: 'Fotossíntese',
                definition: 'Processo pelo qual as plantas convertem luz solar, água e dióxido de carbono em glicose e oxigênio.',
                category: 'biologia'
            },
            {
                _id: '2',
                term: 'Força',
                definition: 'Grandeza física que pode alterar o estado de movimento ou repouso de um corpo, ou deformá-lo.',
                category: 'fisica'
            },
            {
                _id: '3',
                term: 'Equação do Segundo Grau',
                definition: 'Equação polinomial de grau 2, da forma ax² + bx + c = 0, onde a ≠ 0.',
                category: 'matematica'
            }
        ];

        // Carregar termos ao inicializar a página
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadTerms();
        });

        // Submeter formulário de categoria
        document.getElementById('category-form').addEventListener('submit', function(e) {
            e.preventDefault();
            createCategory();
        });

        // Submeter formulário
        document.getElementById('term-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                term: document.getElementById('term').value.trim(),
                definition: document.getElementById('definition').value.trim(),
                category: document.getElementById('category').value
            };

            if (!formData.term || !formData.definition || !formData.category) {
                showMessage('Todos os campos são obrigatórios', 'error');
                return;
            }

            if (editingTermId) {
                updateTerm(editingTermId, formData);
            } else {
                createTerm(formData);
            }
        });

        // Carregar categorias
        async function loadCategories() {
            try {
                let categories;
                
                try {
                    const response = await fetch('/api/categories');
                    
                    if (response.ok) {
                        categories = await response.json();
                    } else {
                        // Se não autenticado, usar dados de exemplo
                        categories = sampleCategories;
                    }
                } catch (error) {
                    // Se erro de rede, usar dados de exemplo
                    categories = sampleCategories;
                }

                const categorySelect = document.getElementById('category');
                
                categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name.charAt(0).toUpperCase() + category.name.slice(1);
                    if (!category.isDefault) {
                        option.textContent += ' (personalizada)';
                    }
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro:', error);
                showMessage('Erro ao carregar categorias', 'error');
                
                // Fallback para dados de exemplo
                const categorySelect = document.getElementById('category');
                categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                
                sampleCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name.charAt(0).toUpperCase() + category.name.slice(1);
                    categorySelect.appendChild(option);
                });
            }
        }

        // Mostrar modal de adicionar categoria
        function showAddCategoryModal() {
            document.getElementById('category-modal').style.display = 'flex';
            document.getElementById('new-category-name').focus();
        }

        // Esconder modal de adicionar categoria
        function hideAddCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
            document.getElementById('category-form').reset();
        }

        // Criar nova categoria
        async function createCategory() {
            try {
                const categoryName = document.getElementById('new-category-name').value.trim();
                
                if (!categoryName) {
                    showMessage('Nome da categoria é obrigatório', 'error');
                    return;
                }

                let success = false;
                
                try {
                    const response = await fetch('/api/categories', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: categoryName })
                    });

                    if (response.ok) {
                        success = true;
                    }
                } catch (error) {
                    // Se erro de rede, simular sucesso localmente
                    success = true;
                }

                if (success) {
                    showMessage('Categoria criada com sucesso!', 'success');
                    hideAddCategoryModal();
                    
                    // Adicionar categoria localmente se não conseguir via API
                    const categorySelect = document.getElementById('category');
                    const option = document.createElement('option');
                    option.value = categoryName.toLowerCase();
                    option.textContent = categoryName.charAt(0).toUpperCase() + categoryName.slice(1) + ' (personalizada)';
                    categorySelect.appendChild(option);
                    categorySelect.value = categoryName.toLowerCase();
                } else {
                    throw new Error('Erro ao criar categoria');
                }
                
            } catch (error) {
                console.error('Erro:', error);
                showMessage(error.message, 'error');
            }
        }

        // Carregar termos
        async function loadTerms() {
            try {
                let terms;
                
                try {
                    const response = await fetch('/api/terms');
                    
                    if (response.ok) {
                        terms = await response.json();
                    } else {
                        // Se não autenticado, usar dados de exemplo
                        terms = sampleTerms;
                    }
                } catch (error) {
                    // Se erro de rede, usar dados de exemplo
                    terms = sampleTerms;
                }

                displayTerms(terms);
            } catch (error) {
                console.error('Erro:', error);
                showMessage('Erro ao carregar termos', 'error');
                document.getElementById('terms-container').innerHTML = 
                    '<div class="empty-state"><h3>Erro ao carregar termos</h3><p>Tente recarregar a página</p></div>';
            }
        }

        // Exibir termos
        function displayTerms(terms) {
            const container = document.getElementById('terms-container');
            
            if (terms.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Nenhum termo cadastrado</h3>
                        <p>Comece adicionando seu primeiro termo acima!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = terms.map(term => `
                <div class="term-item">
                    <div class="term-header">
                        <h3 class="term-title">${escapeHtml(term.term)}</h3>
                        <span class="term-category">${escapeHtml(term.category.charAt(0).toUpperCase() + term.category.slice(1))}</span>
                    </div>
                    <p class="term-definition">${escapeHtml(term.definition)}</p>
                    <div class="term-actions">
                        <button class="btn btn-secondary btn-small" onclick="editTerm('${term._id}')">Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteTerm('${term._id}')">Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        // Criar termo
        async function createTerm(formData) {
            try {
                let success = false;
                
                try {
                    const response = await fetch('/api/terms', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        success = true;
                    }
                } catch (error) {
                    // Se erro de rede, simular sucesso localmente
                    success = true;
                }

                if (success) {
                    showMessage('Termo criado com sucesso!', 'success');
                    document.getElementById('term-form').reset();
                    
                    // Adicionar termo localmente se não conseguir via API
                    const newTerm = {
                        _id: Date.now().toString(),
                        term: formData.term,
                        definition: formData.definition,
                        category: formData.category
                    };
                    
                    sampleTerms.push(newTerm);
                    displayTerms(sampleTerms);
                } else {
                    throw new Error('Erro ao criar termo');
                }
            } catch (error) {
                console.error('Erro:', error);
                showMessage(error.message, 'error');
            }
        }

        // Editar termo
        function editTerm(termId) {
            // Encontrar o termo na lista atual
            const term = sampleTerms.find(t => t._id === termId);
            
            if (term) {
                editingTermId = termId;
                document.getElementById('term-id').value = termId;
                document.getElementById('term').value = term.term;
                document.getElementById('definition').value = term.definition;
                document.getElementById('category').value = term.category;
                
                document.getElementById('form-title').textContent = 'Editar Termo';
                document.getElementById('submit-btn').textContent = 'Atualizar Termo';
                document.getElementById('cancel-btn').style.display = 'inline-block';
                
                // Scroll para o formulário
                document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Atualizar termo
        async function updateTerm(termId, formData) {
            try {
                let success = false;
                
                try {
                    const response = await fetch(`/api/terms/${termId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        success = true;
                    }
                } catch (error) {
                    // Se erro de rede, simular sucesso localmente
                    success = true;
                }

                if (success) {
                    showMessage('Termo atualizado com sucesso!', 'success');
                    cancelEdit();
                    
                    // Atualizar termo localmente se não conseguir via API
                    const termIndex = sampleTerms.findIndex(t => t._id === termId);
                    if (termIndex !== -1) {
                        sampleTerms[termIndex] = { ...sampleTerms[termIndex], ...formData };
                        displayTerms(sampleTerms);
                    }
                } else {
                    throw new Error('Erro ao atualizar termo');
                }
            } catch (error) {
                console.error('Erro:', error);
                showMessage(error.message, 'error');
            }
        }

        // Cancelar edição
        function cancelEdit() {
            editingTermId = null;
            document.getElementById('term-form').reset();
            document.getElementById('term-id').value = '';
            document.getElementById('form-title').textContent = 'Adicionar Novo Termo';
            document.getElementById('submit-btn').textContent = 'Adicionar Termo';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        // Deletar termo
        async function deleteTerm(termId) {
            if (!confirm('Tem certeza que deseja excluir este termo?')) {
                return;
            }

            try {
                let success = false;
                
                try {
                    const response = await fetch(`/api/terms/${termId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        success = true;
                    }
                } catch (error) {
                    // Se erro de rede, simular sucesso localmente
                    success = true;
                }

                if (success) {
                    showMessage('Termo excluído com sucesso!', 'success');
                    
                    // Remover termo localmente se não conseguir via API
                    const termIndex = sampleTerms.findIndex(t => t._id === termId);
                    if (termIndex !== -1) {
                        sampleTerms.splice(termIndex, 1);
                        displayTerms(sampleTerms);
                    }
                } else {
                    throw new Error('Erro ao excluir termo');
                }
            } catch (error) {
                console.error('Erro:', error);
                showMessage(error.message, 'error');
            }
        }

        // Logout
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                window.location.href = '/logout';
            }
        }

        // Exibir mensagem
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="${type}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

